# Fleet Tracker MQTT Broker Configuration
# Mosquitto configuration for production environment

# =============================================================================
# General configuration
# =============================================================================

daemon false
pid_file /var/run/mosquitto.pid

# =============================================================================
# Default Listener (Plain TCP)
# =============================================================================

port 1883
listener 1883 0.0.0.0
max_connections 10000

# =============================================================================
# SSL/TLS Listener (Secure)
# =============================================================================

listener 8883
listener 8883 0.0.0.0

# SSL Certificate files
cafile /mosquitto/ssl/ca.crt
certfile /mosquitto/ssl/server.crt
keyfile /mosquitto/ssl/server.key

# Require certificates from clients
require_certificate true
use_identity_as_username true

# =============================================================================
# WebSocket Listener (for browser clients)
# =============================================================================

listener 9001
protocol websockets

# =============================================================================
# Logging
# =============================================================================

log_dest file /mosquitto/log/mosquitto.log
log_type error
log_type warning
log_type notice

# Connection logging (minimal in production)
connection_messages false
log_timestamp true

# Log rotation
log_facility 5

# =============================================================================
# Security (Production - Strict)
# =============================================================================

# Disable anonymous connections
allow_anonymous false

# Authentication
password_file /mosquitto/config/passwd
acl_file /mosquitto/config/acl.conf

# =============================================================================
# Persistence
# =============================================================================

persistence true
persistence_location /mosquitto/data/
autosave_interval 900

# Persistent client expiration
persistent_client_expiration 1h

# =============================================================================
# Message size limits
# =============================================================================

message_size_limit 2048
max_queued_messages 10000

# =============================================================================
# Keep Alive
# =============================================================================

keepalive_interval 60
max_keepalive 300

# =============================================================================
# Performance Tuning
# =============================================================================

# Max inflight messages per client
max_inflight_messages 20

# Upgrade QoS 0 to QoS 1
upgrade_outgoing_qos false

# =============================================================================
# Bridge Configuration (if needed for clustering)
# =============================================================================

# Example bridge configuration:
# connection bridge-01
# address backup.mqtt.server:1883
# topic fleet/# out 0
# topic fleet/# in 0

# =============================================================================
# Security Policies
# =============================================================================

# Deny access by default
# acl_file enforces these rules:
# - Only authenticated clients can connect
# - Clients can only publish to their own vehicle topics
# - System topics are read-only for regular clients
# - Admin clients have full access
